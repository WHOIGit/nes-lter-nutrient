---
title: "nutrient-mvco-eml-assembly"
author: "Kate Morkeski"
date: "11/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# define source for functions developed for the EDI packaging workflow
#source("edi-utilities.R")

# packages required 
library(here)
library(tidyverse)
library(readxl)
library(lubridate)
library(devtools)
library(EMLassemblyline)
library(EML)
library(maps)
library(xml2)
library(geosphere)
library(httr)
library(compareDF)

#set path to root of project
here("nes-lter-nutrient")

```

## Read in provided data
```{r}

nutrients_input <- read_excel('MVCO_nut_copy01Nov2021.xls') 


```
## Update column names

```{r}

# remove quotation marks and spaces
names(nutrients_input)<- gsub("'", "", names(nutrients_input))
names(nutrients_input)<- gsub(" ", "", names(nutrients_input))
names(nutrients_input)<- gsub("-", "", names(nutrients_input))
names(nutrients_input)<- gsub(" + ", "", names(nutrients_input))

# combine date and time
nutrients_input$Start_Date <- as.character(nutrients_input$Start_Date) 
nutrients_input$Start_Time_UTC <- as.character(nutrients_input$Start_Time_UTC)
nutrients_input$Start_Time_UTC <-gsub("1899-12-31 ", "", nutrients_input$Start_Time_UTC)
nutrients_input$datetime <- paste(nutrients_input$Start_Date, nutrients_input$Start_Time_UTC)
nutrients_input$datetime <- as.POSIXct(nutrients_input$datetime, tz = "GMT", format="%Y-%m-%d %H:%M:%OS")

# rename nutrient columns
nutrients_input <-  nutrients_input %>% 
  rename(nitrate_a = `Nut_a_uMNO2+NO3`) %>% 
  rename(nitrate_b = `Nut_b_uMNO2+NO3`) %>%
  rename(nitrate_c = `Nut_c_uMNO2+NO3`) %>%
  rename(ammonium_a = `Nut_a_uMNH4+`) %>%
  rename(ammonium_b = `Nut_b_uMNH4+`) %>%
  rename(ammonium_c = `Nut_c_uMNH4+`) %>%
  rename(silicate_a = `Nut_a_uMSiO2`) %>%
  rename(silicate_b = `Nut_b_uMSiO2`) %>%
  rename(silicate_c = `Nut_c_uMSiO2`) %>%
  rename(phosphate_a = `Nut_a_uMPO43`) %>%
  rename(phosphate_b = `Nut_b_uMPO43`) %>%
  rename(phosphate_c = `Nut_c_uMPO43`) %>%
  select(-Start_Date, -Start_Time_UTC)  %>%
  relocate(datetime, .before = Latitude)

names(nutrients_input)<- tolower(names(nutrients_input))

# round nutrient concentration columns
nutrients_input <- nutrients_input  %>% 
  mutate(nitrate_a = round(nitrate_a, 3)) %>% 
  mutate(nitrate_b = round(nitrate_b, 3)) %>% 
  mutate(nitrate_c = round(nitrate_c, 3)) %>% 
  mutate(ammonium_a = round(ammonium_a, 3)) %>% 
  mutate(ammonium_b = round(ammonium_b, 3)) %>% 
  mutate(ammonium_c = round(ammonium_c, 3)) %>% 
  mutate(phosphate_a = round(phosphate_a, 3)) %>% 
  mutate(phosphate_b = round(phosphate_b, 3)) %>% 
  mutate(phosphate_c = round(phosphate_c, 3)) %>% 
  mutate(silicate_a = round(silicate_a, 3)) %>% 
  mutate(silicate_b = round(silicate_b, 3)) %>% 
  mutate(silicate_c = round(silicate_c, 3))  

# ensure rows are in time order
nutrients_input <- nutrients_input[order(nutrients_input$datetime),]

# create dataframe for comparison to package version 1 data
# remove event_number_niskin field from this dataframe only
nutr_input_compare <- nutrients_input %>%
 select(-event_number_niskin)

```

## Read in previous MVCO nutrient package to compare to new data set

```{r}

url <- ('https://portal.edirepository.org/nis/dataviewer?packageid=knb-lter-nes.1.2&entityid=9740e9ac9cd58ed3640158fbedef8180')

httr::GET(url, write_disk(tf <- tempfile(fileext = ".csv")))
tf

nutr_pubd <- read_csv(tf, TRUE) 


```

# format previous dataframe

```{r}

# rename nutrient columns
nutr_pubd <-  nutr_pubd %>% 
  rename(datetime = 'time (UTC)') %>% 
  rename(nitrate_a = ntra_a) %>% 
  rename(nitrate_b = ntra_b) %>%
  rename(nitrate_c = ntra_c) %>%
  rename(ammonium_a = amon_a) %>%
  rename(ammonium_b = amon_b) %>%
  rename(ammonium_c = amon_c) %>%
  rename(silicate_a = slca_a) %>%
  rename(silicate_b =  slca_b) %>%
  rename(silicate_c =  slca_c) %>%
  rename(phosphate_a = phos_a) %>%
  rename(phosphate_b = phos_b) %>%
  rename(phosphate_c = phos_c) 

# ensure rows are in time order
nutr_pubd <- nutr_pubd[order(nutr_pubd$datetime),]

```

# compare original and new versions of nutrient data and export table of differences

```{r}

comparison <- compare_df(nutr_input_compare, nutr_pubd, c("event_number", "depth"))

create_output_table(comparison, output_type='xlsx', file_name='version_comparison.xlsx')

# findings: 
# 4 instances in which nutrient concentrations differ by 0.001 between versions due to rounding 
# many instances in which longitude differs by 0.001 between versions
# new version includes these event numbers not included in the original version:
    # MVCO_003-MVCO_045, May 2003-Feb 2006
    # MVCO_368, 24-August-2016, original had only one depth, new version includes 3 additional depths
    # MVCO_382-MVCO_435, June 2017-November 2020

```

## Pivot new data table to handle replicates

```{r}

nitrate <- nutrients_input %>% 
 select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
 select(-silicate_a, -silicate_b, -silicate_c) %>%
 select(-phosphate_a, -phosphate_b, -phosphate_c)  %>% 
 pivot_longer(cols = c(nitrate_a, nitrate_b, nitrate_c), names_to = "replicate",  values_to = "nitrate")  
nitrate$replicate <- gsub("nitrate_", "", nitrate$replicate)
  
ammonium <- nutrients_input %>% 
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-silicate_a, -silicate_b, -silicate_c) %>%
  select(-phosphate_a, -phosphate_b, -phosphate_c) %>% 
  pivot_longer(cols = c(ammonium_a, ammonium_b, ammonium_c), names_to = "replicate",  values_to = "ammonium") 
ammonium$replicate <- gsub("ammonium_", "", ammonium$replicate)
  
silicate <- nutrients_input %>%  
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
  select(-phosphate_a, -phosphate_b, -phosphate_c) %>%
  pivot_longer(cols = c(silicate_a, silicate_b, silicate_c), names_to = "replicate",  values_to = "silicate") 
silicate$replicate <- gsub("silicate_", "", silicate$replicate)
  
phosphate <- nutrients_input %>% 
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
  select(-silicate_a, -silicate_b, -silicate_c) %>%
  pivot_longer(cols = c(phosphate_a, phosphate_b, phosphate_c), names_to = "replicate",  values_to = "phosphate")
phosphate$replicate <- gsub("phosphate_", "", phosphate$replicate)

nutrients_long <- full_join(nitrate, ammonium, by = c("event_number", "event_number_niskin", "datetime", "latitude", "longitude", "depth", "replicate"))
nutrients_long <- full_join(nutrients_long, silicate, by = c("event_number", "event_number_niskin", "datetime", "latitude", "longitude", "depth", "replicate"))
nutrients_long <- full_join(nutrients_long, phosphate, by = c("event_number", "event_number_niskin", "datetime", "latitude", "longitude", "depth", "replicate"))

```

  
## Check range and check for outliers
# similar to nutrient transect markdown




```{r}

#plot(pressure)

```

## EML Assembly

```{r}

#plot(pressure)

```
