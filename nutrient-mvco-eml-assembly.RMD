---
title: "nutrient-mvco-eml-assembly"
author: "Kate Morkeski"
date: "11/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# define source for functions developed for the EDI packaging workflow
#source("edi-utilities.R")

# define R packages to require 
require(here)
require(tidyverse)
require(readxl)
require(lubridate)
require(devtools)
require(EMLassemblyline)
require(EML)
require(maps)
require(xml2)
require(geosphere)
require(httr)
require(compareDF)

#set path to root of project
here("nes-lter-nutrient")

```

## Read in provided data
```{r}

nutrients_input <- read_excel('MVCO_nut_copy01Nov2021.xls') 


```
## Update column names

```{r}

# remove quotation marks and spaces
names(nutrients_input)<- gsub("'", "", names(nutrients_input))
names(nutrients_input)<- gsub(" ", "", names(nutrients_input))
names(nutrients_input)<- gsub("-", "", names(nutrients_input))
names(nutrients_input)<- gsub(" + ", "", names(nutrients_input))

# combine date and time
nutrients_input$Start_Date <- as.character(nutrients_input$Start_Date) 
nutrients_input$Start_Time_UTC <- as.character(nutrients_input$Start_Time_UTC)
nutrients_input$Start_Time_UTC <-gsub("1899-12-31 ", "", nutrients_input$Start_Time_UTC)
nutrients_input$datetime <- paste(nutrients_input$Start_Date, nutrients_input$Start_Time_UTC)
nutrients_input$datetime <- as.POSIXct(nutrients_input$datetime, tz = "GMT", format="%Y-%m-%d %H:%M:%OS")

# rename nutrient columns
nutrients_input <-  nutrients_input %>% 
  rename(nitrate_a = `Nut_a_uMNO2+NO3`) %>% 
  rename(nitrate_b = `Nut_b_uMNO2+NO3`) %>%
  rename(nitrate_c = `Nut_c_uMNO2+NO3`) %>%
  rename(ammonium_a = `Nut_a_uMNH4+`) %>%
  rename(ammonium_b = `Nut_b_uMNH4+`) %>%
  rename(ammonium_c = `Nut_c_uMNH4+`) %>%
  rename(silicate_a = `Nut_a_uMSiO2`) %>%
  rename(silicate_b = `Nut_b_uMSiO2`) %>%
  rename(silicate_c = `Nut_c_uMSiO2`) %>%
  rename(phosphate_a = `Nut_a_uMPO43`) %>%
  rename(phosphate_b = `Nut_b_uMPO43`) %>%
  rename(phosphate_c = `Nut_c_uMPO43`) %>%
  select(-Start_Date, -Start_Time_UTC)  %>%
  relocate(datetime, .before = Latitude)

names(nutrients_input)<- tolower(names(nutrients_input))

# round nutrient concentration columns
nutrients_input <- nutrients_input  %>% 
  mutate(nitrate_a = round(nitrate_a, 3)) %>% 
  mutate(nitrate_b = round(nitrate_b, 3)) %>% 
  mutate(nitrate_c = round(nitrate_c, 3)) %>% 
  mutate(ammonium_a = round(ammonium_a, 3)) %>% 
  mutate(ammonium_b = round(ammonium_b, 3)) %>% 
  mutate(ammonium_c = round(ammonium_c, 3)) %>% 
  mutate(phosphate_a = round(phosphate_a, 3)) %>% 
  mutate(phosphate_b = round(phosphate_b, 3)) %>% 
  mutate(phosphate_c = round(phosphate_c, 3)) %>% 
  mutate(silicate_a = round(silicate_a, 3)) %>% 
  mutate(silicate_b = round(silicate_b, 3)) %>% 
  mutate(silicate_c = round(silicate_c, 3))  

# ensure rows are in time order
nutrients_input <- nutrients_input[order(nutrients_input$datetime),]

nutr_input_compare <- nutrients_input %>%
 select(-event_number_niskin)

```
## Pivot data table to handle replicates

```{r}

nitrate <- nutrients_input %>% 
 select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
 select(-silicate_a, -silicate_b, -silicate_c) %>%
 select(-phosphate_a, -phosphate_b, -phosphate_c)  %>% 
 pivot_longer(cols = c(nitrate_a, nitrate_b, nitrate_c), names_to = "replicate",  values_to = "nitrate")  
nitrate$replicate <- gsub("nitrate_", "", nitrate$replicate)
  
ammonium <- nutrients_input %>% 
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-silicate_a, -silicate_b, -silicate_c) %>%
  select(-phosphate_a, -phosphate_b, -phosphate_c) %>% 
  pivot_longer(cols = c(ammonium_a, ammonium_b, ammonium_c), names_to = "replicate",  values_to = "ammonium") 
ammonium$replicate <- gsub("ammonium_", "", ammonium$replicate)
  
silicate <- nutrients_input %>%  
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
  select(-phosphate_a, -phosphate_b, -phosphate_c) %>%
  pivot_longer(cols = c(silicate_a, silicate_b, silicate_c), names_to = "replicate",  values_to = "silicate") 
silicate$replicate <- gsub("silicate_", "", silicate$replicate)
  
phosphate <- nutrients_input %>% 
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
  select(-silicate_a, -silicate_b, -silicate_c) %>%
  pivot_longer(cols = c(phosphate_a, phosphate_b, phosphate_c), names_to = "replicate",  values_to = "phosphate")
phosphate$replicate <- gsub("phosphate_", "", phosphate$replicate)

nutrients_long <- full_join(nitrate, ammonium, by = c("event_number", "event_number_niskin", "datetime", "latitude", "longitude", "depth", "replicate"))
nutrients_long <- full_join(nutrients_long, silicate, by = c("event_number", "event_number_niskin", "datetime", "latitude", "longitude", "depth", "replicate"))
nutrients_long <- full_join(nutrients_long, phosphate, by = c("event_number", "event_number_niskin", "datetime", "latitude", "longitude", "depth", "replicate"))

```

## Read in previous MVCO nutrient package and compare to new data set

```{r}

url <- ('https://portal.edirepository.org/nis/dataviewer?packageid=knb-lter-nes.1.2&entityid=9740e9ac9cd58ed3640158fbedef8180')

httr::GET(url, write_disk(tf <- tempfile(fileext = ".csv")))
tf

nutr_pubd <- read_csv(tf, TRUE) 


```
```{r}

# rename nutrient columns
nutr_pubd <-  nutr_pubd %>% 
  rename(datetime = 'time (UTC)') %>% 
  rename(nitrate_a = ntra_a) %>% 
  rename(nitrate_b = ntra_b) %>%
  rename(nitrate_c = ntra_c) %>%
  rename(ammonium_a = amon_a) %>%
  rename(ammonium_b = amon_b) %>%
  rename(ammonium_c = amon_c) %>%
  rename(silicate_a = slca_a) %>%
  rename(silicate_b =  slca_b) %>%
  rename(silicate_c =  slca_c) %>%
  rename(phosphate_a = phos_a) %>%
  rename(phosphate_b = phos_b) %>%
  rename(phosphate_c = phos_c) 

# ensure rows are in time order
nutr_pubd <- nutr_pubd[order(nutr_pubd$datetime),]

```
## Pivot data table to handle replicates

```{r}

prev_nitrate <- nutr_pubd %>% 
 select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
 select(-silicate_a, -silicate_b, -silicate_c) %>%
 select(-phosphate_a, -phosphate_b, -phosphate_c)  %>% 
 pivot_longer(cols = c(nitrate_a, nitrate_b, nitrate_c), names_to = "replicate",  values_to = "nitrate")  
prev_nitrate$replicate <- gsub("nitrate_", "", prev_nitrate$replicate)
  
prev_ammonium <- nutr_pubd %>% 
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-silicate_a, -silicate_b, -silicate_c) %>%
  select(-phosphate_a, -phosphate_b, -phosphate_c) %>% 
  pivot_longer(cols = c(ammonium_a, ammonium_b, ammonium_c), names_to = "replicate",  values_to = "ammonium") 
prev_ammonium$replicate <- gsub("ammonium_", "", prev_ammonium$replicate)
  
prev_silicate <- nutr_pubd %>%  
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
  select(-phosphate_a, -phosphate_b, -phosphate_c) %>%
  pivot_longer(cols = c(silicate_a, silicate_b, silicate_c), names_to = "replicate",  values_to = "silicate") 
prev_silicate$replicate <- gsub("silicate_", "", prev_silicate$replicate)
  
prev_phosphate <- nutr_pubd %>% 
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
  select(-silicate_a, -silicate_b, -silicate_c) %>%
  pivot_longer(cols = c(phosphate_a, phosphate_b, phosphate_c), names_to = "replicate",  values_to = "phosphate")
prev_phosphate$replicate <- gsub("phosphate_", "", prev_phosphate$replicate)

nutr_pubd_long <- full_join(prev_nitrate, prev_ammonium, by = c("event_number", "datetime", "latitude", "longitude", "depth", "replicate"))
nutr_pubd_long <- full_join(nutr_pubd_long, prev_silicate, by = c("event_number", "datetime", "latitude", "longitude", "depth", "replicate"))
nutr_pubd_long <- full_join(nutr_pubd_long, prev_phosphate, by = c("event_number", "datetime", "latitude", "longitude", "depth", "replicate"))

# convert NaN to NA
nutr_pubd_long <- nutr_pubd_long %>% 
  mutate(nitrate = replace(nitrate, nitrate == "NaN", NA)) %>% 
  mutate(ammonium = replace(ammonium, ammonium == "NaN", NA)) %>% 
  mutate(phosphate = replace(phosphate, phosphate == "NaN", NA)) %>% 
  mutate(silicate = replace(silicate, silicate == "NaN", NA)) 

# rename nutrients columns 
nutr_pubd_long <-  nutr_pubd_long %>% 
  rename(nitrate_old = nitrate) %>% 
  rename(ammonium_old = ammonium) %>%
  rename(silicate_old = silicate) %>%
  rename(phosphate_old = phosphate) 

```

## Compare previous nutrients data set to new data set

```{r}

# # join old and new data sets
# #nutrients_compare_right <- right_join(nutrients_long, nutr_pubd_long, by = c("event_number", "latitude", "longitude", "depth", "replicate"))
# # use this right join in order to work with only the rows that are included in the old data set
# 
# #nutrients_compare_left <- left_join(nutrients_long, nutr_pubd_long, by = c("event_number", "latitude", "longitude", "depth", "replicate"))
# nutrients_compare_full <- full_join(nutrients_long, nutr_pubd_long, by = c("event_number", "depth"))
# #nutrients_compare_inner <- inner_join(nutrients_long, nutr_pubd_long, by = c("event_number", "latitude", "longitude", "depth", "replicate"))
# 
# # compare nutrient values
# nutrients_compare <- nutrients_compare_full  %>% 
#   mutate(nitrate_diff = nitrate-nitrate_old)  %>% 
#   mutate(ammonium_diff = ammonium-ammonium_old)  %>% 
#   mutate(phosphate_diff = phosphate-phosphate_old)  %>% 
#   mutate(silicate_diff = silicate-silicate_old) 
# 
# # check for non-zero differences
# unique(nutrients_compare$nitrate_diff)
# unique(nutrients_compare$ammonium_diff)
# unique(nutrients_compare$phosphate_diff)
# unique(nutrients_compare$silicate_diff)
# 
# # isolate non-zero differences in new dataframe
# nutrient_check <- nutrients_compare %>%
#   filter(nitrate_diff != 0 | ammonium_diff != 0 | phosphate_diff != 0 | silicate_diff != 0)  
# print(paste0((nrow(nutrient_check)), " rows have unequal values"))
# 
# # these identify the same values as above
# # nitrate_diff <- nutrients_compare %>%
# #   filter(nitrate != nitrate_old) 
# # amm_diff <- nutrients_compare %>%
# #   filter(ammonium != ammonium_old)
# # phos_diff <- nutrients_compare %>%
# #   filter(phosphate != phosphate_old)
# # sil_diff <- nutrients_compare %>%
# #   filter(silicate != silicate_old)
# 
# # isolate rows with a value in one data set and NA in corresponding data set 
# # using only nitrate for this initial check 
# missing_nitrate_new <- nutrients_compare %>%
#   filter(is.na(nitrate) & (!is.na(nitrate_old))) 
# missing_nitrate_old <- nutrients_compare %>%
#   filter(!is.na(nitrate) & (is.na(nitrate_old))) 
# print(paste0((nrow(missing_nitrate_new)), " rows in new data file are missing nitrate values compared to old file"))
# print(paste0((nrow(missing_nitrate_old)), " rows in old data file are missing nitrate values compared to new file"))
#   
# # count rows with a value in one data set and NA in corresponding data set 
# # redundant # using only nitrate
# print(paste0("new nutrient file has ", sum(!is.na(nutrients_compare$nitrate)), " nitrate values corresponding to old data" ))
# print(paste0("new nutrient file has ", sum(is.na(nutrients_compare$nitrate)), " nitrate NAs corresponding to old data" ))
# print(paste0("old nutrient file has ", sum(!is.na(nutrients_compare$nitrate_old)), " nitrate values" ))
# print(paste0("old nutrient file has ", sum(is.na(nutrients_compare$nitrate_old)), " nitrate NAs" ))
#    
# # count_diff <- nutrients_compare %>%
# #   filter(!is.na(nitrate_diff))
# # count_old <- nutr_pubd_long %>%
# #   filter(!is.na(nitrate_old))
# # count_NaN <- nutr_pubd_long %>%
# #   filter(nitrate_old == "NaN")

```

```{r}

# prep new data set to compare with old

# filter by event number 
# need to strip event number out of character to do this
#nutrients_long_old <- nutrients_long %>%
#  filter(event_number > )

  
```

# compare original and new versions of nutrient data and export table of differences

```{r}

comparison <- compare_df(nutr_input_compare, nutr_pubd, c("event_number", "depth"))

create_output_table(comparison, output_type='xlsx', file_name='version_comparison.xlsx')

# findings: 
# 4 instances in which nutrient concentrations differ by 0.001 between versions due to rounding 
# many instances in which longitude differs by 0.001 between versions
# new version includes these event numbers not included in the original version:
    # MVCO_003-MVCO_045, May 2003-Feb 2006
    # MVCO_368, 24-August-2016, original had only one depth, new version includes 3 additional depths
    # MVCO_382-MVCO_435, June 2017-November 2020

```
  
## Check range and check for outliers
# similar to nutrient transect markdown




```{r}

#plot(pressure)

```

## EML Assembly

```{r}

#plot(pressure)

```
