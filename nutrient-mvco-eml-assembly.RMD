---
title: "nutrient-mvco-eml-assembly"
author: "Kate Morkeski"
date: "11/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load required packages 

# two of the required packages are installed from GitHub
# uncomment these lines to update as needed
# library(remotes)
# remotes::install_github("EDIorg/EMLassemblyline")
# remotes::install_github("WHOIGit/ediutilities")

library(EMLassemblyline)
library(ediutilities)
library(here)
library(tidyverse)
library(readxl)
library(lubridate)
library(devtools)
library(EML)
library(maps)
library(xml2)
library(geosphere)
library(httr)
library(compareDF)

#set path to root of project
here("nes-lter-nutrient")

```

## Read in provided data
```{r}

nutrients_input <- read_excel('MVCO_nut_copy01Nov2021.xls') 


```
## Update column names

```{r}

# remove quotation marks and spaces
names(nutrients_input)<- gsub("'", "", names(nutrients_input))
names(nutrients_input)<- gsub(" ", "", names(nutrients_input))
names(nutrients_input)<- gsub("-", "", names(nutrients_input))
names(nutrients_input)<- gsub(" + ", "", names(nutrients_input))

# combine date and time
nutrients_input$Start_Date <- as.character(nutrients_input$Start_Date) 
nutrients_input$Start_Time_UTC <- as.character(nutrients_input$Start_Time_UTC)
nutrients_input$Start_Time_UTC <-gsub("1899-12-31 ", "", nutrients_input$Start_Time_UTC)
nutrients_input$datetime <- paste(nutrients_input$Start_Date, nutrients_input$Start_Time_UTC)
nutrients_input$datetime <- as.POSIXct(nutrients_input$datetime, tz = "GMT", format="%Y-%m-%d %H:%M:%OS")

# rename nutrient columns
nutrients_input <-  nutrients_input %>% 
  rename(nitrate_a = `Nut_a_uMNO2+NO3`) %>%  # nitrate is really nitrate + nitrite #keep simple for wrangling then rename
  rename(nitrate_b = `Nut_b_uMNO2+NO3`) %>%
  rename(nitrate_c = `Nut_c_uMNO2+NO3`) %>%
  rename(ammonium_a = `Nut_a_uMNH4+`) %>%
  rename(ammonium_b = `Nut_b_uMNH4+`) %>%
  rename(ammonium_c = `Nut_c_uMNH4+`) %>%
  rename(silicate_a = `Nut_a_uMSiO2`) %>%
  rename(silicate_b = `Nut_b_uMSiO2`) %>%
  rename(silicate_c = `Nut_c_uMSiO2`) %>%
  rename(phosphate_a = `Nut_a_uMPO43`) %>%
  rename(phosphate_b = `Nut_b_uMPO43`) %>%
  rename(phosphate_c = `Nut_c_uMPO43`) %>%
  select(-Start_Date, -Start_Time_UTC)  %>%
  relocate(datetime, .before = Latitude)

names(nutrients_input)<- tolower(names(nutrients_input))

# round nutrient concentration columns
nutrients_input <- nutrients_input  %>% 
  mutate(nitrate_a = round(nitrate_a, 3)) %>% 
  mutate(nitrate_b = round(nitrate_b, 3)) %>% 
  mutate(nitrate_c = round(nitrate_c, 3)) %>% 
  mutate(ammonium_a = round(ammonium_a, 3)) %>% 
  mutate(ammonium_b = round(ammonium_b, 3)) %>% 
  mutate(ammonium_c = round(ammonium_c, 3)) %>% 
  mutate(phosphate_a = round(phosphate_a, 3)) %>% 
  mutate(phosphate_b = round(phosphate_b, 3)) %>% 
  mutate(phosphate_c = round(phosphate_c, 3)) %>% 
  mutate(silicate_a = round(silicate_a, 3)) %>% 
  mutate(silicate_b = round(silicate_b, 3)) %>% 
  mutate(silicate_c = round(silicate_c, 3))  

# ensure rows are in time order
nutrients_input <- nutrients_input[order(nutrients_input$datetime),]

# create dataframe for comparison to package version 1 data
# remove event_number_niskin field from this dataframe only
nutr_input_compare <- nutrients_input %>%
 select(-event_number_niskin)

```

## Read in version 1 MVCO nutrient package to compare to new data set

```{r}

url <- ('https://portal.edirepository.org/nis/dataviewer?packageid=knb-lter-nes.1.2&entityid=9740e9ac9cd58ed3640158fbedef8180')

httr::GET(url, write_disk(tf <- tempfile(fileext = ".csv")))
tf

nutr_pubd <- read_csv(tf, TRUE, show_col_types = FALSE) 


```

# format version 1 dataframe

```{r}

# rename nutrient columns
nutr_pubd <-  nutr_pubd %>% 
  rename(datetime = 'time (UTC)') %>% 
  rename(nitrate_a = ntra_a) %>% 
  rename(nitrate_b = ntra_b) %>%
  rename(nitrate_c = ntra_c) %>%
  rename(ammonium_a = amon_a) %>%
  rename(ammonium_b = amon_b) %>%
  rename(ammonium_c = amon_c) %>%
  rename(silicate_a = slca_a) %>%
  rename(silicate_b =  slca_b) %>%
  rename(silicate_c =  slca_c) %>%
  rename(phosphate_a = phos_a) %>%
  rename(phosphate_b = phos_b) %>%
  rename(phosphate_c = phos_c) 

# ensure rows are in time order
nutr_pubd <- nutr_pubd[order(nutr_pubd$datetime),]

```

# compare original and new versions of nutrient data and export table of differences

```{r}

comparison <- compare_df(nutr_input_compare, nutr_pubd, c("event_number", "depth"))

create_output_table(comparison, output_type='xlsx', file_name='version_comparison.xlsx')

# findings: 
# 4 instances in which nutrient concentrations differ by 0.001 between versions due to rounding 
# many instances in which longitude differs by 0.001 between versions
# new version includes these event numbers not included in the original version:
    # MVCO_003-MVCO_045, May 2003-Feb 2006
    # MVCO_368, 24-August-2016, original had only one depth, new version includes 3 additional depths
    # MVCO_382-MVCO_435, June 2017-November 2020

```

## Pivot current data table to handle replicates

```{r}

nitrate <- nutrients_input %>% 
 select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
 select(-silicate_a, -silicate_b, -silicate_c) %>%
 select(-phosphate_a, -phosphate_b, -phosphate_c)  %>% 
 pivot_longer(cols = c(nitrate_a, nitrate_b, nitrate_c), names_to = "replicate",  values_to = "nitrate")  
nitrate$replicate <- gsub("nitrate_", "", nitrate$replicate)
  
ammonium <- nutrients_input %>% 
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-silicate_a, -silicate_b, -silicate_c) %>%
  select(-phosphate_a, -phosphate_b, -phosphate_c) %>% 
  pivot_longer(cols = c(ammonium_a, ammonium_b, ammonium_c), names_to = "replicate",  values_to = "ammonium") 
ammonium$replicate <- gsub("ammonium_", "", ammonium$replicate)
  
silicate <- nutrients_input %>%  
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
  select(-phosphate_a, -phosphate_b, -phosphate_c) %>%
  pivot_longer(cols = c(silicate_a, silicate_b, silicate_c), names_to = "replicate",  values_to = "silicate") 
silicate$replicate <- gsub("silicate_", "", silicate$replicate)
  
phosphate <- nutrients_input %>% 
  select(-nitrate_a, -nitrate_b, -nitrate_c) %>%
  select(-ammonium_a, -ammonium_b, -ammonium_c) %>%
  select(-silicate_a, -silicate_b, -silicate_c) %>%
  pivot_longer(cols = c(phosphate_a, phosphate_b, phosphate_c), names_to = "replicate",  values_to = "phosphate")
phosphate$replicate <- gsub("phosphate_", "", phosphate$replicate)

nutrients_long <- full_join(nitrate, ammonium, by = c("event_number", "event_number_niskin", "datetime", "latitude", "longitude", "depth", "replicate"))
nutrients_long <- full_join(nutrients_long, silicate, by = c("event_number", "event_number_niskin", "datetime", "latitude", "longitude", "depth", "replicate"))
nutrients_long <- full_join(nutrients_long, phosphate, by = c("event_number", "event_number_niskin", "datetime", "latitude", "longitude", "depth", "replicate"))

```

# QC: Nutrient Outlier Check

# Check if there are severe differences in nutrient values across replicates. Plot these differences to perform a visual check.

# this is based on nutrient transect check that is by cruise/cast/niskin. Is it useful here? 

```{r}

# calculate the difference between the replicates across all nutrients
nut_check <- nutrients_long %>%
  group_by(event_number_niskin) %>%
    mutate(nitrate_diff = abs(nitrate - lead(nitrate)),
          ammonium_diff = abs(ammonium - lead(ammonium)),
          phosphate_diff = abs(phosphate - lead(phosphate)),
          silicate_diff = abs(silicate - lead(silicate))) 

# define the nutrient outlier columns to gather on
nut_diff_cols <- c("nitrate_diff", "phosphate_diff", "ammonium_diff", "silicate_diff")
# convert to long for ease of plotting
nut_check_long <- nut_check %>%
  select(nitrate_diff, ammonium_diff, phosphate_diff, silicate_diff) %>%
  filter(nitrate_diff != 0) %>%
  gather(nutrient_diffs, value, nut_diff_cols)

# plot the differences and look for outliers
ggplot(data = nut_check_long, aes(x = nutrient_diffs, y = value)) +
    geom_boxplot(outlier.size = 0.5) +
    ylab(paste0("Concentration (µmol/L)")) +
    theme_classic()

# why rearranged to alphabetical order? 

```


## QA: Plot nutrients as a check

Make boxplots based on all nutrient values

```{r}

# define the nutrient columns 
nut_cols <- c("nitrate", "phosphate", "ammonium", "silicate")
# convert to long for ease of plotting
nutrients_longer <- nutrients_long %>%
    gather(nutrient, value, nut_cols, factor_key = TRUE)

# boxplot of the 4 nutrients in single panel
ggplot(nutrients_longer, aes(x=nutrient, y=value))+geom_boxplot(outlier.size = 0.5)+theme_classic()

# boxplots of individual nutrients
for (i in 1:length(nut_cols)) {
  nut_subset <- nutrients_longer %>% filter(nutrient == nut_cols[i])
  
  # ggplot where x = cast, y = value and the lineplots are grouped by cruise
  p <- ggplot(data = nut_subset, aes(x = nutrient, y = value)) +
    geom_boxplot(outlier.size = 0.5) +
    ylab(paste0(nut_cols[i], " concentration (µmol/L)")) +
    theme_classic()
  print(p)
}



```

## QA: Determine if any nutrient values exceed expectations

According to a global range check: nitrate less than 30 umol/l and ammonium less than 5 umol/l based on [Rees et al. 2006](https://doi.org/10.1016/j.dsr2.2006.05.008), phosphate less than 3 (no great reference but this appears to be upper for Atlantic), silicate less than 60 (Elements of Physical Oceanography chapter on marine silica cycle, for deep Atlantic, this is probably too high).

```{r}

summary(nutrients_long) # visual min max for all columns
# visually check the printed nutrient data for maxima exceeding excpected thresholds:
# nitrate > 30 
# ammonium > 5
# phosphate > 3
# silicate > 60

# filter for values exceeding the thresholds
high_nitrate <- nutrients_long %>%  filter(nitrate > 30)
high_ammonium <- nutrients_long %>% filter(ammonium > 5)
high_phosphate <- nutrients_long %>% filter(phosphate > 3)
high_silicate <- nutrients_long %>% filter(silicate > 60)

# check console output for summary and alerts
print(paste(nrow(high_nitrate), "nitrate observations exceed max" ))
print(paste(nrow(high_ammonium), "ammonium observations exceed max" ))
print(paste(nrow(high_phosphate), "phosphate observations exceed max" ))
print(paste(nrow(high_silicate), "silicate observations exceed max" ))
 
# investigate high ammonium values
hist(high_ammonium$ammonium)

# could rbind all high nutrient data frames for better reproducibility # this way is simpler
write.csv(high_ammonium, "high_ammonium.csv")

```


## EML Assembly

```{r}

# rename nitrate column to nitrate+nitrite
nutrients_long <- rename(nutrients_long, nitrate_nitrite = nitrate)


```
